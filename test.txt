include("include/SOVIETInstructions.txt");
defineVariable(int, _stopBuildingId);
defineVariable(Building, _building);
defineVariable(Resources, _resources);
defineVariable(int, _numberOfVehicles);
defineVariable(Vehicle, _vehicle);
defineVariable(vec3, vector);

defineVariable(int, i);
defineVariable(int, j);
defineVariable(int, k);
defineVariable(int, m);
defineVariable(int, _vehicleIndex);

defineVariable(int, _random);
defineVariable(int, _minEventsInterval);
defineVariable(int, _eventsRandomInterval);
defineVariable(int, _nextEventWaiting);
defineVariable(int, _eventType);
defineVariable(int, _eventTypesCount);
defineVariable(int, _eventTime);
defineVariable(float, _deliveredResources);
defineVariable(float, _resourcesToDeliver);
defineVariable(char, _deliveryPending);

defineArray(int[20], _departuredPlanes);
defineArray(int[20], _arrivingPlanes);
defineArray(float[20], _departuredPlanesCargo);
defineVariable(int, _departedPlanesCount);
defineVariable(char, _planeIsOnDepartureList);
defineVariable(char, _planeIsOnArrivalList);
defineVariable(int, _planeIndexInArray);
defineVariable(float, _time);

defineVariable(float, _returnValue);
defineVariable(float, _resourcesAmount);

defineVariable(float, UNKNOWN);
defineVariable(float, HEADING_BORDER);
defineVariable(float, HEADING_AIRPORT);



defineStruct(Plane, 106)
{
	defineStructVariable(Plane, int, id);
	// state 1 - heading to border with cargo, 2 - heading to terminal without cargo
	defineStructVariable(Plane, char, state);
	defineStructVariable(Plane, char, lastState);
	defineStructVariable(Plane, float, exported);
	defineStructVariable(Plane, float, lastCargo);
}
defineVariable(Plane, _currentPlane);
defineArray(Plane[20], _planes);
defineVariable(int, _currentPlaneIndex);



defineFunction(SetupTarget, void, int: type)
{
	// todo: multiply if player has bigger planes
	if(type ? 0)
	{
		_resourcesToDeliver = 12.0;
		Objective_AddRequirement("delivery", _resourcesToDeliver, "resources/eletronics.png");
	}
	elseif(type ? 1)
	{
		//_resourcesToDeliver = 18.0;
		_resourcesToDeliver = 64.0;
		Objective_AddRequirement("delivery", _resourcesToDeliver, "resources/mcomponents.png");
	}
	returnVoid();
}

defineFunction(ResourcesGetFromEventType, float, int: typeOfEvent)
{
	// todo: multiply if player has bigger planes
	if(typeOfEvent ? 0)
	{
		_returnValue = _resources.eletronics;
	}
	elseif(typeOfEvent ? 1)
	{
		_returnValue = _resources.mcomponents;
	}
	return(_returnValue);
}


defineFunction(main, void)
{
	InitConstants();
	UNKNOWN = 0;
	HEADING_BORDER = 1;
	HEADING_AIRPORT = 2;
	
	// main loop
	while(1 ? 1)
	{
		// new random time interval for next event
		Random(_random);
		//todo: remove debug
		//_minEventsInterval = 30 * 60;
		//_eventsRandomInterval = 90 * 60;
		_minEventsInterval = 3;
		_eventsRandomInterval = 2;
		_nextEventWaiting = _minEventsInterval + _random % _eventsRandomInterval;
		
		// wait for next event
		for (i = 0, i < _nextEventWaiting, i = i + 1)
		{
			Script_Sleep(1.0);
		}
		 
		// handle event
		
		// rng event type
		Random(_random);
		//todo: remove debug
		//_eventType = _random % _eventTypesCount;
		_eventType = 1;
		_deliveryPending = 1;
			
		Objectives_CreateNewString("delivery", "Soviet delivery");
		
		SetupTarget(_eventType);
		Objective_AddRequirement("delivery", 10.0, "editor/status_waiting.png");
	
		Notification_CreateNewStringPic(
		"Aerial delivery",
		"Deliver specified cargo on time to get reward.",
		"resources/airplanes.png",
		vector);
		
		_departedPlanesCount = 0;
		_eventTime = 10 * 60;
		_time = 0.0;
		//event time counter
		while(_deliveryPending ? 1 & j < _eventTime)
		{
			Vehicle_GetNumberOfVehicles(_numberOfVehicles);   
			for (_vehicleIndex = 0, _vehicleIndex < _numberOfVehicles, _vehicleIndex = _vehicleIndex + 1)
			{
				_vehicle.GetDataByIndex(_vehicleIndex);
				if(_vehicle.nVehicleType ? VEHICLETYPE_AIRPLANE)
				{
					_currentPlaneIndex = 150;
					// check if plane is on list
					for(k = 0, k < _departedPlanesCount, k = k + 1)
					{
						_currentPlane = _planes[k];
						if(_currentPlane.id ? _vehicleIndex)
						{
							_currentPlaneIndex = k;
						}
					}
					
					_resources.GetFromVehicle(_vehicleIndex);
					_resourcesAmount = ResourcesGetFromEventType(_eventType);
					_stopBuildingId = _vehicle.nBuilding_StationBuildingID;
					_building.GetDataByIndex(_stopBuildingId);
					
					//plane on list
					if(!(_currentPlaneIndex ? 150))
					{	
						_currentPlane = _planes[_currentPlaneIndex];
						_currentPlane.lastState = _currentPlane.state;
						// check if is heading to border with cargo
						// todo: validate if custom is NATO or Soviet
						if(_resourcesAmount > 2.0 & _building.nType ? BUILDINGTYPE_CUSTOMHOUSE)
						{
							// just departure from terminal
							if(_currentPlane.lastState ? 2)
							{
								Window_ShowText("kolejny wylot");
								_currentPlane.lastCargo = _resourcesAmount;
							}
							_currentPlane.state = HEADING_BORDER;
						}
						
						// check if is heading to airport
						if( _building.nType ? BUILDINGTYPE_CARGO_STATION | _building.nType ? BUILDINGTYPE_AIRPLANE_PARKING)
						{
							// check if empty
							if(_resourcesAmount < 1.0)
							{
								_currentPlane.state = HEADING_AIRPORT;
							}
						}
						
						// just departure from border
						if(_currentPlane.lastState ? HEADING_BORDER & _currentPlane.state ? HEADING_AIRPORT)
						{
							_currentPlane.exported = _currentPlane.exported + _currentPlane.lastCargo;
							_currentPlane.lastCargo = 0.0;
						}
						
						_planes[_currentPlaneIndex] = _currentPlane;
						
					}
					// not on list 
					// check if is heading to border with cargo

					// todo: validate if custom is NATO or Soviet
					else()
					{
						if(_resourcesAmount > 2.0 & _building.nType ? BUILDINGTYPE_CUSTOMHOUSE)
						{  
								_currentPlane.id = _vehicleIndex;
								_currentPlane.state = HEADING_BORDER;
								_currentPlane.lastState = HEADING_BORDER;
								_currentPlane.exported = 0.0;
								_currentPlane.lastCargo = _resourcesAmount;
								
								_planes[_departedPlanesCount] = _currentPlane;
								_departedPlanesCount = _departedPlanesCount + 1;
						}
					}
				}
			}
			
			_deliveredResources = 0.0;
			for (k = 0, k < 20 + 1, k = k + 1)
			{
				_deliveredResources = _deliveredResources + _planes[k].exported;
			}
			
			if(_deliveredResources > _resourcesToDeliver)
			{
				Objective_UpdateRequirementToTarget("delivery", 0);
				Objective_SetComplete("delivery");
				Notification_CreateNewStringPic(
					"Delivery completed",
					"You exported all required products. You will be rewarded with additional bonus.",
					"editor/status_ok.png",
					vector);
				_deliveryPending = 0;
				
				// todo: reward
				
				Script_Sleep(10.0);
			}
			else()
			{
				Objective_UpdateRequirement("delivery", 0, _deliveredResources);
			}
			
			
			Script_Sleep(1.0);
			j = j + 1;
			_time = _time + 0.01666;
			Objective_UpdateRequirement("delivery", 1, _time);
		}
		if(_deliveryPending ? 1)
		{
			Notification_CreateNewStringPic(
					"Delivery failed",
					"The time for delivery is over.",
					"editor/status_notok.png",
					vector);
		}
		Objectives_ClearAll();
		
		// clear departuredPlanes
		for (k = 0, k < 20, k = k + 1)
		{
			_currentPlane =  _planes[k];
			_currentPlane.id = 0;
			_currentPlane.state = UNKNOWN;
			_currentPlane.lastState = UNKNOWN;
			_currentPlane.exported = 0.0;
			_currentPlane.lastCargo = 0.0;
			_planes[k] = _currentPlane;
		}
	}
	end();
}

